{% extends 'base.html' %}

{% block title %}ตะกร้าสินค้า - Pet Store{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">หน้าแรก</a></li>
            <li class="breadcrumb-item"><a href="{% url 'pet_list' %}">สัตว์เลี้ยง</a></li>
            <li class="breadcrumb-item active">ตะกร้าสินค้า</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="fas fa-shopping-cart"></i> ตะกร้าสินค้า</h2>
            <p class="text-muted">สินค้าในตะกร้าของคุณ</p>
        </div>
    </div>

    <!-- Cart Items -->
    <div class="row">
        <div class="col-md-8">
            {% if pets_in_cart %}
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> รายการสินค้าในตะกร้า ({{ cart_count }} ชิ้น)
                    </h5>
                </div>
                <div class="card-body">
                    {% for item in pets_in_cart %}
                    <div class="cart-item border-bottom pb-3 mb-3">
                        <div class="row align-items-center">
                            <!-- Product Image -->
                            <div class="col-md-2">
                                {% if item.pet.image_display %}
                                    <img src="{{ item.pet.image_display }}" 
                                         class="img-fluid rounded" 
                                         alt="{{ item.pet.name }}"
                                         style="height: 80px; width: 80px; object-fit: cover;"
                                         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2Y4ZjhmOCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='">
                                {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                         style="height: 80px; width: 80px;">
                                        <i class="fas fa-paw text-muted"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Product Info -->
                            <div class="col-md-4">
                                <h6 class="mb-1">{{ item.pet.name }}</h6>
                                <p class="mb-1 text-muted small">
                                    <span class="badge bg-secondary">{{ item.pet.category.name }}</span>
                                    <span class="badge {% if item.pet.gender == 'M' %}bg-info{% else %}bg-pink{% endif %}">
                                        {% if item.pet.gender == 'M' %}ชาย{% else %}หญิง{% endif %}
                                    </span>
                                </p>
                                <p class="mb-0 text-primary fw-bold">฿{{ item.pet.price|floatformat:2 }}</p>
                            </div>
                            
                            <!-- Quantity Controls -->
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary btn-sm quantity-btn" 
                                            onclick="updateQuantity({{ item.pet.id }}, -1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="mx-3 fw-bold" id="quantity-{{ item.pet.id }}">
                                        {{ item.quantity }}
                                    </span>
                                    <button class="btn btn-outline-secondary btn-sm quantity-btn" 
                                            onclick="updateQuantity({{ item.pet.id }}, 1)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Item Total & Actions -->
                            <div class="col-md-3 text-end">
                                <div class="mb-2">
                                    <strong class="text-primary">฿{{ item.total_price|floatformat:2 }}</strong>
                                </div>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="removeFromCart({{ item.pet.id }})">
                                    <i class="fas fa-trash"></i> ลบ
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Delivery Information Form -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-clock"></i> ข้อมูลการรับสินค้า
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="recipient_name" class="form-label fw-bold">
                                    <i class="fas fa-user"></i> ชื่อผู้รับสินค้า
                                </label>
                                <input type="text" class="form-control" id="recipient_name" 
                                       placeholder="กรอกชื่อผู้รับสินค้า" 
                                       value="{{ user.get_full_name|default:user.username }}"
                                       required>
                                <div class="form-text">กรอกชื่อ-นามสกุลของผู้ที่จะมารับสินค้า</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pickup_date" class="form-label fw-bold">
                                    <i class="fas fa-calendar-day"></i> วันที่มารับสินค้า
                                </label>
                                <input type="date" class="form-control" id="pickup_date" 
                                       min="{{ today|date:'Y-m-d' }}" required>
                                <div class="form-text">เลือกวันที่ต้องการมารับสินค้า</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Store Information -->
                    <div class="alert alert-light mt-3">
                        <h6><i class="fas fa-store text-primary"></i> สถานที่รับสินค้า</h6>
                        <p class="mb-1"><strong>Pet Store สาขาหลัก</strong></p>
                        <p class="mb-1">123 ถนนเพชรบุรี แขวงทุ่งพญาไท เขตราชเทวี</p>
                        <p class="mb-1">กรุงเทพมหานคร 10400</p>
                        <p class="mb-0"><i class="fas fa-phone"></i> โทร: 02-123-4567</p>
                        <p class="mb-0"><i class="fas fa-clock"></i> เวลาให้บริการ: 09:00 - 20:00 น. (ทุกวัน)</p>
                    </div>

                    <!-- Important Notes -->
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-exclamation-circle"></i> ข้อควรทราบ</h6>
                        <ul class="mb-0">
                            <li>กรุณานำบัตรประจำตัวประชาชนหรือบัตรที่ทางร้านออกให้มาแสดงในวันรับสินค้า</li>
                            <li>สามารถเปลี่ยนชื่อผู้รับและวันที่มารับได้ก่อนกดสั่งซื้อ</li>
                            <li>หากไม่สะดวกมารับในวันที่กำหนด กรุณาติดต่อร้านล่วงหน้า</li>
                        </ul>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Empty Cart State -->
            <div class="card text-center">
                <div class="card-body py-5">
                    <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">ตะกร้าสินค้าว่าง</h4>
                    <p class="text-muted mb-4">ยังไม่มีสินค้าในตะกร้าของคุณ</p>
                    <a href="{% url 'pet_list' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-paw"></i> ไปเลือกสัตว์เลี้ยง
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Order Summary -->
        <div class="col-md-4">
            {% if pets_in_cart %}
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-receipt"></i> สรุปคำสั่งซื้อ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>จำนวนสินค้า:</span>
                        <span>{{ cart_count }} ชิ้น</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>ค่าจัดส่ง:</span>
                        <span class="text-success">ฟรี</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>วิธีการรับ:</span>
                        <span class="text-info">รับสินค้าเอง</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>ยอดรวมทั้งสิ้น:</strong>
                        <strong class="text-primary fs-5">฿{{ total_price|floatformat:2 }}</strong>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" onclick="checkout()">
                            <i class="fas fa-credit-card"></i> สั่งซื้อเลย
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearCart()">
                            <i class="fas fa-trash"></i> ล้างตะกร้า
                        </button>
                    </div>

                    <!-- Order Summary Details -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="mb-2"><i class="fas fa-info-circle"></i> สรุป订单</h6>
                        <div id="order-summary-details">
                            <small class="text-muted">กรุณากรอกข้อมูลการรับสินค้าด้านซ้าย</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Help Section -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> ข้อมูลเพิ่มเติม
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-store text-primary"></i> รับสินค้าเอง</h6>
                        <p class="small text-muted mb-0">เปิดบริการทุกวัน 09:00 - 20:00 น.</p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-shield-alt text-primary"></i> การรับประกัน</h6>
                        <p class="small text-muted mb-0">รับประกันสุขภาพสัตว์เลี้ยง 7 วัน</p>
                    </div>
                    <div>
                        <h6><i class="fas fa-headset text-primary"></i> ช่วยเหลือ</h6>
                        <p class="small text-muted mb-0">ติดต่อ: 02-123-4567</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Continue Shopping -->
    {% if pets_in_cart %}
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'pet_list' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> เลือกสัตว์เลี้ยงเพิ่ม
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Hidden form for checkout -->
<form id="checkout-form" method="POST" action="{% url 'create_order_from_cart' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="cart" id="checkout-cart-data">
    <input type="hidden" name="delivery_method" id="checkout-delivery-method" value="pickup">
    <input type="hidden" name="pickup_date" id="checkout-pickup-date">
    <input type="hidden" name="recipient_name" id="checkout-recipient-name">
</form>

<style>
.bg-pink {
    background-color: #e83e8c !important;
}
.cart-item {
    transition: background-color 0.2s ease;
}
.cart-item:hover {
    background-color: #f8f9fa;
}
.quantity-btn {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.sticky-top {
    position: sticky;
    z-index: 100;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // Get current cart from localStorage
    function getCart() {
        return JSON.parse(localStorage.getItem('cart') || '[]');
    }
    
    // Save cart to localStorage and reload page with cart data
    function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        
        // Reload page with cart data in URL
        const cartQuery = encodeURIComponent(JSON.stringify(cart));
        window.location.href = `{% url 'cart' %}?cart=${cartQuery}`;
    }
    
    // Update quantity
    function updateQuantity(petId, change) {
        let cart = getCart();
        const itemIndex = cart.findIndex(item => item.petId === petId);
        
        if (itemIndex !== -1) {
            const newQuantity = cart[itemIndex].quantity + change;
            
            if (newQuantity <= 0) {
                // Remove item if quantity becomes 0 or less
                cart.splice(itemIndex, 1);
                showToast('ลบสินค้าออกจากตะกร้าเรียบร้อย', 'warning');
            } else {
                // Update quantity
                cart[itemIndex].quantity = newQuantity;
                showToast('อัพเดทจำนวนเรียบร้อยแล้ว', 'success');
            }
            
            saveCart(cart);
        }
    }
    
    // Remove item from cart
    function removeFromCart(petId) {
        if (confirm('คุณแน่ใจว่าต้องการลบสินค้านี้ออกจากตะกร้า?')) {
            let cart = getCart();
            cart = cart.filter(item => item.petId !== petId);
            saveCart(cart);
            showToast('ลบสินค้าออกจากตะกร้าเรียบร้อย', 'warning');
        }
    }
    
    // Clear entire cart
    function clearCart() {
        if (confirm('คุณแน่ใจว่าต้องการล้างตะกร้าทั้งหมด?')) {
            localStorage.removeItem('cart');
            showToast('ล้างตะกร้าเรียบร้อยแล้ว', 'info');
            setTimeout(() => {
                window.location.href = "{% url 'cart' %}";
            }, 1000);
        }
    }

    // Update order summary
    function updateOrderSummary() {
        const recipientName = document.getElementById('recipient_name').value;
        const pickupDate = document.getElementById('pickup_date').value;
        
        const summaryElement = document.getElementById('order-summary-details');
        
        if (recipientName && pickupDate) {
            const date = new Date(pickupDate);
            const formattedDate = date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            summaryElement.innerHTML = `
                <div class="mb-1"><strong>ผู้รับ:</strong> ${recipientName}</div>
                <div class="mb-1"><strong>วันที่รับ:</strong> ${formattedDate}</div>
                <div class="mb-1"><strong>สถานที่:</strong> สาขาหลัก</div>
            `;
        } else {
            summaryElement.innerHTML = '<small class="text-muted">กรุณากรอกข้อมูลการรับสินค้าด้านซ้าย</small>';
        }
    }
    
    // Checkout process
    function checkout() {
        const cart = getCart();
        
        if (cart.length === 0) {
            showToast('ตะกร้าสินค้าว่าง', 'warning');
            return;
        }
        
        // Validate form
        const recipientName = document.getElementById('recipient_name').value.trim();
        const pickupDate = document.getElementById('pickup_date').value;
        
        if (!recipientName) {
            showToast('กรุณากรอกชื่อผู้รับสินค้า', 'warning');
            document.getElementById('recipient_name').focus();
            return;
        }
        
        if (!pickupDate) {
            showToast('กรุณาเลือกวันที่มารับสินค้า', 'warning');
            document.getElementById('pickup_date').focus();
            return;
        }
        
        // Check if pickup date is in the future
        const selectedDate = new Date(pickupDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            showToast('ไม่สามารถเลือกวันที่ในอดีตได้', 'warning');
            return;
        }
        
        if (confirm(`ยืนยันการสั่งซื้อ?\n\nผู้รับ: ${recipientName}\nวันที่รับ: ${pickupDate}`)) {
            // Set form data
            document.getElementById('checkout-cart-data').value = JSON.stringify(cart);
            document.getElementById('checkout-recipient-name').value = recipientName;
            document.getElementById('checkout-pickup-date').value = pickupDate;
            
            // Submit form
            document.getElementById('checkout-form').submit();
        }
    }
    
    // Toast notification
    function showToast(message, type) {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${getToastIcon(type)} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function () {
            toast.remove();
        });
    }
    
    // Get appropriate icon for toast type
    function getToastIcon(type) {
        switch(type) {
            case 'success': return 'check-circle';
            case 'warning': return 'exclamation-triangle';
            case 'danger': return 'times-circle';
            case 'info': return 'info-circle';
            default: return 'info-circle';
        }
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        updateCartCount();
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        const pickupDateField = document.getElementById('pickup_date');
        if (pickupDateField) {
            pickupDateField.min = today;
        }
        
        // Add event listeners for form fields
        document.getElementById('recipient_name')?.addEventListener('input', updateOrderSummary);
        document.getElementById('pickup_date')?.addEventListener('change', updateOrderSummary);
        
        // If coming from another page without cart data, send current cart
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.has('cart')) {
            const currentCart = getCart();
            if (currentCart.length > 0) {
                const cartQuery = encodeURIComponent(JSON.stringify(currentCart));
                window.location.href = `{% url 'cart' %}?cart=${cartQuery}`;
            }
        }
    });
</script>
{% endblock %}